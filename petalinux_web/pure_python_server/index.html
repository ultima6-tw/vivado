<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AWG Control Panel</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45;margin:24px;color:#222}
  h1{font-size:20px;margin:0 0 12px}
  fieldset{border:1px solid #ccc;border-radius:8px;padding:12px;margin:12px 0}
  legend{padding:0 6px;color:#555}
  label{display:block;margin:8px 0 4px}
  input[type="range"]{width:100%}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > div{flex:1 1 300px}
  button{padding:10px 16px;border:0;border-radius:8px;background:#0b6efd;color:#fff;cursor:pointer}
  button:hover{background:#0955c4}
  .muted{color:#666;font-size:13px}
  .value{font-weight:bold;margin-left:8px}
  /* hide response block */
  #respBox, h2 { display:none; }
</style>
</head>
<body>
  <h1>AWG Control Panel</h1>
  <p class="muted">Select center frequency (500 Hz ~ 450 kHz) and amplitude (0 ~ 1.25 V).<br>
  You can choose to output 1, 3, 5, or 7 lines. Out-of-range indices will be disabled automatically.</p>

  <form id="awgForm" method="post" action="/apply">
    <!-- Fixed parameters (hidden) -->
    <input type="hidden" name="data_chip"   value="/dev/gpiochip0">
    <input type="hidden" name="wen_chip"    value="/dev/gpiochip3">
    <input type="hidden" name="wen_offset"  value="0">
    <input type="hidden" name="wen_active"  value="1">
    <input type="hidden" name="wen_pulse_us" value="1">

    <fieldset>
      <legend>Channel A</legend>
      <div class="row">
        <div>
          <label for="freqA">Center frequency (Hz) <span id="freqA_val" class="value">1000</span></label>
          <input id="freqA" type="range" min="500" max="450000" step="500" value="1000">
        </div>
        <div>
          <label for="gainA_v">Amplitude (V) <span id="gainA_val" class="value">1.25</span></label>
          <input id="gainA_v" type="range" min="0" max="1.25" step="0.01" value="1.25">
        </div>
        <div>
          <label for="countA">Number of outputs</label>
          <select id="countA">
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="7">7</option>
          </select>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Channel B</legend>
      <div class="row">
        <div>
          <label for="freqB">Center frequency (Hz) <span id="freqB_val" class="value">1000</span></label>
          <input id="freqB" type="range" min="500" max="450000" step="500" value="1000">
        </div>
        <div>
          <label for="gainB_v">Amplitude (V) <span id="gainB_val" class="value">1.25</span></label>
          <input id="gainB_v" type="range" min="0" max="1.25" step="0.01" value="1.25">
        </div>
        <div>
          <label for="countB">Number of outputs</label>
          <select id="countB">
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="7">7</option>
          </select>
        </div>
      </div>
    </fieldset>

    <div class="row" style="align-items:center">
      <div><button type="button" id="sendBtn">Apply AWG Settings</button></div>
      <div><button type="button" id="clearBtn" style="background:#6c757d">Reset to default</button></div>
    </div>
  </form>

  <h2>Response</h2>
  <pre id="respBox">(Not yet submitted)</pre>

<script>
const FREQ_MIN=500,FREQ_MAX=450000,IDX_MIN=0,IDX_MAX=899;
function clamp(v,min,max){return v<min?min:(v>max?max:v);}
function freqHzToIndex(hz){
  const f=clamp(hz,FREQ_MIN,FREQ_MAX);
  const ratio=(f-FREQ_MIN)/(FREQ_MAX-FREQ_MIN);
  return Math.round(ratio*IDX_MAX);
}
function buildIdxGainFromFreq(centerHz,count,maxVolt){
  const rawIdx=freqHzToIndex(centerHz);
  const center=clamp(rawIdx,IDX_MIN,IDX_MAX);
  const idx=[],gains=new Array(8).fill(0);
  for(let i=-3;i<=4;i++) idx.push(center+i);
  const k=(count-1)/2, start=3-k,end=3+k;
  const volt=clamp(maxVolt,0,1.25);
  const scale=volt/1.25, per=scale/count;
  for(let i=0;i<8;i++){
    const raw=idx[i], inRange=(raw>=IDX_MIN && raw<=IDX_MAX);
    idx[i]=clamp(raw,IDX_MIN,IDX_MAX);
    if(i>=start && i<=end && inRange) gains[i]=per;
  }
  return {idx,gains};
}
function setResponse(obj){
  const box=document.getElementById('respBox');
  box.style.display="block";
  document.querySelector("h2").style.display="block";
  box.textContent=(typeof obj==='string')?obj:JSON.stringify(obj,null,2);
}

['freqA','freqB','gainA_v','gainB_v'].forEach(id=>{
  const el = document.getElementById(id);
  const spanId = id.endsWith('_v') ? id.replace('_v','') + '_val' : id + '_val';
  const span = document.getElementById(spanId);
  const update = () => { span.textContent = el.value; };
  el.addEventListener('input', update);
  update(); // initialize
});

document.getElementById('sendBtn').addEventListener('click',async()=>{
  try{
    const freqA=parseInt(document.getElementById('freqA').value);
    const freqB=parseInt(document.getElementById('freqB').value);
    const gainA_v=parseFloat(document.getElementById('gainA_v').value);
    const gainB_v=parseFloat(document.getElementById('gainB_v').value);
    const countA=parseInt(document.getElementById('countA').value);
    const countB=parseInt(document.getElementById('countB').value);

    const A=buildIdxGainFromFreq(freqA,countA,gainA_v);
    const B=buildIdxGainFromFreq(freqB,countB,gainB_v);

    const params=new URLSearchParams();
    params.append("data_chip","/dev/gpiochip0");
    params.append("wen_chip","/dev/gpiochip3");
    params.append("wen_offset","0");
    params.append("wen_active","1");
    params.append("wen_pulse_us","1");
    params.append("idxA",A.idx.join(","));
    params.append("idxB",B.idx.join(","));
    params.append("gainA_f",A.gains.join(","));
    params.append("gainB_f",B.gains.join(","));

    fetch("/apply", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params.toString(),
      keepalive: true
    }).catch(() => { /* 靜默忽略送出錯誤 */ });
  }catch(e){setResponse({ok:false,error:e.message});}
});
document.getElementById('clearBtn').addEventListener('click',()=>{
  document.getElementById('freqA').value=1000;
  document.getElementById('freqB').value=1000;
  document.getElementById('gainA_v').value=1.25;
  document.getElementById('gainB_v').value=1.25;
  document.getElementById('countA').value=5;
  document.getElementById('countB').value=5;
  document.getElementById('freqA_val').textContent="1000";
  document.getElementById('freqB_val').textContent="1000";
  document.getElementById('gainA_val').textContent="1.25";
  document.getElementById('gainB_val').textContent="1.25";
  setResponse("(Not yet submitted)");
});
</script>
</body>
</html>